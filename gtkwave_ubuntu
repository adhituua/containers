ARG IMAGE="ubuntu:xenial"

#
# Build GtkWave
#

FROM $IMAGE AS build-base

WORKDIR /work

RUN apt-get update -qq \
 && DEBIAN_FRONTEND=noninteractive apt-get -y install --no-install-recommends \
    ca-certificates \
    gcc \
    git \
    libstdc++-8-dev \
    make \
      build-essential \
      flex \
      gawk \
      gperf \
      libbz2-dev \
      libreadline-dev \
      libffi-dev \
      libgtk-3-dev \
      liblzma-dev \
      pkg-config \
      subversion \
      tcl-dev \
      tk-dev \
 && apt-get autoclean && apt-get clean && apt-get -y autoremove \
 && update-ca-certificates

RUN mkdir -pv /tmp/gtkwave && cd /tmp/gtkwave \
 && svn checkout svn://svn.code.sf.net/p/gtkwave/code/gtkwave3-gtk3 ./ \
 && ./configure --prefix="/usr/local" --with-tk=/usr/lib --enable-gtk3 \
 && make -j$(nproc) DESTDIR="$(pwd)/build-dir" \
 && make check \
 && make install DESTDIR="$(pwd)/build-dir" \
 && tar -zcvf /tmp/gtkwave.tgz -C build-dir/usr/local/ . \
 && cd .. && rm -rf gtkwave

#
# GtkWave
#

FROM $IMAGE AS base

RUN apt update -qq \
 && DEBIAN_FRONTEND=noninteractive apt -y install --no-install-recommends \
    ca-certificates \
    gcc \
    git \
    graphviz \
    libc6-dev \
    libgnat-8 \
    libgtk-3-0 \
    libllvm6.0 \
    libtcl8.6 \
    libtk8.6 \
    make \
    python3 \
    python3-pip \
    tango-icon-theme \
    time \
    xdot \
    xterm \
    zlib1g-dev \
 && apt autoclean && apt clean && apt -y autoremove \
 && update-ca-certificates

#  && echo 'gtk-icon-theme-name = "Tango"' >> /usr/share/themes/Raleigh/gtk-2.0/gtkrc

COPY --from=build-base /tmp/gtkwave.tgz /tmp/

RUN tar -xzf /tmp/gtkwave.tgz -C /usr/local \
 && rm -f /tmp/*
